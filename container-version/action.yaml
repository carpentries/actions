name: 'container-version'
description: 'Action to get the Docker container version from Docker Hub'
author: 'Robert P. Davey'
inputs:
  WORKBENCH_TAG:
    description: 'Override Workbench version tag, e.g. "v0.15.0" or "latest". Defaults to "latest".'
    required: false
    default: 'latest'
outputs:
  container-version:
    description: 'Docker container version'
    value: ${{ steps.wb-vers.outputs.container-version }}
  last-container-version:
    description: 'Previous successful build Docker container version'
    value: ${{ steps.prev-wb-vers.outputs.last-build-container-version }}
  workbench-container-file-exists:
    description: 'Does the workbench-docker-version.txt file exist?'
    value: ${{ steps.check-ver-file.outputs.version-file-exists }}

runs:
  using: "composite"
  steps:
    - name: "Checkout Lesson"
      uses: actions/checkout@v4

    - name: Get Container Version Used
      id: wb-vers
      run: |
        # Getting version tag from DockerHub metadata #
        tag=${{ inputs.WORKBENCH_TAG || 'latest' }}
        digest=$(curl -s "https://hub.docker.com/v2/repositories/carpentries/workbench-docker/tags?name=$tag" | jq -r '.results[] | select(.name == "'$tag'") | .digest')
        if [[ "$tag" == "latest" ]]; then
          vers=$(curl -s "https://hub.docker.com/v2/repositories/carpentries/workbench-docker/tags" | jq -r '.results[] | select(.digest == "'$digest'") | .name')
          VER=$(echo "$vers" | grep -Po "^v.*")
        else
          VER="$tag"
        fi
        echo "container-version=$VER" >> $GITHUB_OUTPUT
      shell: bash

    - name: Check version file exists
      id: check-ver-file
      run: |
        # Checking last successful build container version file #
        LAST_VER_FILE=".github/workbench-docker-version.txt"
        if [[ -f "$LAST_VER_FILE" ]]; then
          echo "version-file-exists=true" >> $GITHUB_OUTPUT
        else
          echo "version-file-exists=false" >> $GITHUB_OUTPUT
        fi
      shell: bash

    - name: Get Previous Container Version Used
      id: prev-wb-vers
      run: |
        # Getting last successful build container version #
        LAST_VER_FILE=".github/workbench-docker-version.txt"
        if [[ -f "$LAST_VER_FILE" ]]; then
          LAST_VER=$(cat "$LAST_VER_FILE")
        else
          LAST_VER=""
        fi
        echo "last-build-container-version=$LAST_VER" >> $GITHUB_OUTPUT
      shell: bash
